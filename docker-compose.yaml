version: '3.8'

services:
  # PostgreSQL - Core Relational Database
  postgres:
    image: postgres:16-alpine
    container_name: sentinel-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-sentinel}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-sentinel}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    command:
      - postgres
      - -c
      - max_connections=200
      - -c
      - shared_buffers=256MB
      - -c
      - effective_cache_size=1GB
      - -c
      - maintenance_work_mem=64MB
      - -c
      - checkpoint_completion_target=0.9
      - -c
      - wal_buffers=16MB
      - -c
      - default_statistics_target=100
      - -c
      - random_page_cost=1.1
      - -c
      - effective_io_concurrency=200
      - -c
      - work_mem=4MB
      - -c
      - min_wal_size=1GB
      - -c
      - max_wal_size=4GB
    networks:
      - sentinel-network

  # Weaviate - Vector Database
  weaviate:
    image: semitechnologies/weaviate:1.24.4
    container_name: sentinel-weaviate
    restart: unless-stopped
    ports:
      - "${WEAVIATE_PORT:-8080}:8080"
      - "${WEAVIATE_GRPC_PORT:-50051}:50051"
    environment:
      QUERY_DEFAULTS_LIMIT: ${WEAVIATE_QUERY_LIMIT:-25}
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: ${WEAVIATE_AUTH_ANONYMOUS:-'true'}
      PERSISTENCE_DATA_PATH: ${WEAVIATE_DATA_PATH:-'/var/lib/weaviate'}
      DEFAULT_VECTORIZER_MODULE: ${WEAVIATE_VECTORIZER:-'none'}
      ENABLE_MODULES: ${WEAVIATE_MODULES:-'text2vec-openai,generative-openai'}
      CLUSTER_HOSTNAME: ${WEAVIATE_HOSTNAME:-'node1'}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-''}
      # Performance optimizations
      DISABLE_TELEMETRY: 'true'
      LOG_LEVEL: ${WEAVIATE_LOG_LEVEL:-'info'}
    volumes:
      - weaviate_data:/var/lib/weaviate
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/v1/.well-known/ready"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    networks:
      - sentinel-network

  # Backend - Rust Application
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: sentinel-backend
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      weaviate:
        condition: service_healthy
    ports:
      - "${BACKEND_PORT:-3000}:3000"
    environment:
      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-sentinel}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-sentinel}
      # Weaviate
      WEAVIATE_URL: http://weaviate:8080
      WEAVIATE_API_KEY: ${WEAVIATE_API_KEY:-''}
      # OpenAI
      OPENAI_API_KEY: ${OPENAI_API_KEY:-''}
      # Application
      RUST_LOG: ${RUST_LOG:-'info,sentinel=debug'}
      RUST_BACKTRACE: ${RUST_BACKTRACE:-'1'}
      PORT: ${BACKEND_PORT:-3000}
      HOST: ${BACKEND_HOST:-'0.0.0.0'}
      # Sled (local storage)
      SLED_PATH: ${SLED_PATH:-'/app/data/sled'}
    volumes:
      - backend_data:/app/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - sentinel-network

  # Frontend - React/Vite Application
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: sentinel-frontend
    restart: unless-stopped
    depends_on:
      - backend
    ports:
      - "${FRONTEND_PORT:-80}:80"
    environment:
      VITE_API_URL: ${VITE_API_URL:-'http://localhost:3000'}
      VITE_API_BASE_URL: ${VITE_API_BASE_URL:-'http://localhost:3000'}
    networks:
      - sentinel-network

networks:
  sentinel-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
  weaviate_data:
    driver: local
  backend_data:
    driver: local

